<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Simple WebRTC Video Call Demo</title>
    <style>
      video {
        width: 45%;
        margin: 10px;
        border: 1px solid #ccc;
      }
      #warnings {
        background: #ffdddd;
        color: #900;
        padding: 10px;
        margin: 10px 0;
        border: 1px solid #900;
        font-family: sans-serif;
      }
    </style>
  </head>
  <body>
    <h2>Simple WebRTC Video Call Demo</h2>

    <!-- 🔍 Extension interference warning will appear here -->
    <div id="warnings"></div>

    <div>
      <h3>Your Video</h3>
      <video id="my-video" autoplay playsinline muted></video>
    </div>
    <div>
      <h3>Remote Video</h3>
      <video id="remote-video" autoplay playsinline></video>
    </div>

    <div>
      <h3>Your Peer ID:</h3>
      <p id="my-id">Generating...</p>
    </div>

    <div>
      <input type="text" id="remote-id" placeholder="Enter remote peer ID">
      <button id="call-btn">Call</button>
    </div>

    <!-- 🔍 Tampering detection script -->
    <script>
      (function checkForTampering() {
        let warnings = [];

        // Check if mediaDevices looks native
        const md = navigator.mediaDevices;
        if (!md || typeof md.getUserMedia !== "function") {
          warnings.push("⚠️ navigator.mediaDevices is missing or altered.");
        } else {
          const mdStr = md.getUserMedia.toString();
          if (!mdStr.includes("[native code]")) {
            warnings.push("⚠️ getUserMedia seems to be overridden by an extension.");
          }
        }

        // Check if RTCPeerConnection looks native
        const PC = window.RTCPeerConnection || window.webkitRTCPeerConnection;
        if (!PC) {
          warnings.push("⚠️ RTCPeerConnection not available.");
        } else {
          const pcStr = PC.toString();
          if (!pcStr.includes("[native code]")) {
            warnings.push("⚠️ RTCPeerConnection may be patched by an extension.");
          }
        }

        if (warnings.length > 0) {
          const warningsDiv = document.getElementById("warnings");
          warningsDiv.innerHTML = `
            <strong>Possible Extension Interference Detected</strong><br>
            ${warnings.join("<br>")}<br>
            Try running this demo in <b>Incognito mode</b> or disabling extensions.
          `;
        }
      })();
    </script>

    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
      const myVideo = document.getElementById("my-video");
      const remoteVideo = document.getElementById("remote-video");
      const myIdElem = document.getElementById("my-id");
      const remoteIdInput = document.getElementById("remote-id");
      const callBtn = document.getElementById("call-btn");

      // Get user media
      navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
          myVideo.srcObject = stream;

          const peer = new Peer();

          peer.on("open", id => {
            myIdElem.textContent = id;
          });

          peer.on("call", call => {
            call.answer(stream);
            call.on("stream", remoteStream => {
              remoteVideo.srcObject = remoteStream;
            });
          });

          callBtn.addEventListener("click", () => {
            const remoteId = remoteIdInput.value;
            const call = peer.call(remoteId, stream);
            call.on("stream", remoteStream => {
              remoteVideo.srcObject = remoteStream;
            });
          });
        })
        .catch(err => {
          console.error("Failed to get local stream", err);
        });
    </script>
  </body>
</html>
